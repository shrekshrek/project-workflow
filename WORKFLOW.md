# Claude Code 项目工作流手册 (Project Workflow Guide)

> **定位**: 本手册是 `README.md`（技能参考手册）的配套实操指南。
> README 回答"有什么工具"，本手册回答"怎么用这些工具跑完一个项目"。

---

## 目录

1. [项目生命周期总览](#1-项目生命周期总览)
2. [Plan Mode 与 /plan 命令](#2-plan-mode-与-plan-命令)
3. [Phase 0：立项与规划](#3-phase-0立项与规划)
4. [Phase 1：架构设计](#4-phase-1架构设计)
5. [Phase 2：模块开发（核心循环）](#5-phase-2模块开发核心循环)
6. [Phase 3：集成与收尾](#6-phase-3集成与收尾)
7. [会话管理：开始与结束仪式](#7-会话管理开始与结束仪式)
8. [跨会话持续性策略](#8-跨会话持续性策略)
9. [质量关卡速查](#9-质量关卡速查)
10. [故障排除与常见陷阱](#10-故障排除与常见陷阱)
11. [附录：CLAUDE.md 模板](#11-附录claudemd-模板)

---

## 1. 项目生命周期总览

```
Phase 0          Phase 1          Phase 2              Phase 3
立项与规划  →  架构设计  →  模块开发(循环)  →  集成与收尾
                                ↑       |
                                +-------+
                              (每个模块迭代)
```

| 阶段 | 目标 | 核心指令 | 产出物 |
|:---|:---|:---|:---|
| Phase 0 | 明确做什么、不做什么 | Brainstorming | 需求清单、CLAUDE.md 初版 |
| Phase 1 | 确定技术方案与模块拆分 | `/feature-dev` 或 `/plan` + Mermaid | 架构图、模块清单、CLAUDE.md 完善版 |
| Phase 2 | 逐模块实现 | Plan 模式 → `/tdd` → 验证 → `/code-review` → `/commit` | 可运行的代码 + 测试 |
| Phase 3 | 全局验证与上线 | `/e2e` → `/review-pr` → `/commit-push-pr` | PR、部署产物 |

---

## 2. Plan Mode 与 /plan 命令

在深入工作流之前，必须理解两个容易混淆的规划工具。它们是不同层面的东西，可以搭配使用。

### Plan Mode（内置模式切换）

Claude Code 内置的**权限模式**，通过 `Shift+Tab` 在输入框中循环切换：

```
Shift+Tab 循环：Normal → Plan → Auto-accept → Normal → ...
```

| 模式 | Claude 的行为 |
|:---|:---|
| **Normal** | 默认模式，每次编辑都请求你批准 |
| **Plan** | **只思考和讨论，不修改任何文件**。你可以反复对话直到方案满意 |
| **Auto-accept** | 自动执行所有编辑，不再逐个请求批准 |

也可以通过 CLI 启动时指定：`claude --permission-mode plan`

> **Claude Code 创始人 Boris Cherny 的做法**：几乎所有非平凡任务都先进入 Plan 模式，反复讨论直到满意，再切到 Auto-accept 让 Claude 一次完成。
> *"A good plan is really important!"*

### /plan 命令（ECC 插件）

`/plan` 是 everything-claude-code 插件提供的斜杠命令，调用 **Planner Agent** 输出一份结构化的实施步骤文档。

### 区别与搭配

| 维度 | Plan Mode (`Shift+Tab`) | `/plan` 命令 |
|:---|:---|:---|
| 来源 | Claude Code 内置 | everything-claude-code 插件 |
| 本质 | **模式开关**，控制 Claude 是否能编辑文件 | **Agent 调用**，输出实施计划文档 |
| 持续时间 | 持续生效直到你再次切换 | 一次性输出后结束 |
| 交互方式 | 自由对话，Claude 始终不动代码 | Agent 分析后输出步骤清单 |

**推荐搭配使用**：

```
1. Shift+Tab → 进入 Plan 模式（锁住 Claude 不动代码）
2. /plan "需求描述"（让 Planner Agent 输出详细步骤）
3. 在 Plan 模式下反复讨论、修改计划
4. 满意后 Shift+Tab → 切到 Auto-accept 模式
5. Claude 按计划执行
```

---

## 3. Phase 0：立项与规划

**目标**: 从模糊的想法收敛到可执行的需求清单。

### 步骤 1：头脑风暴

```
帮我头脑风暴一下 XXX 项目的方案
```

Brainstorming 技能会引导你思考：
- 核心用户是谁？解决什么问题？
- MVP 包含哪些功能？哪些是 v2？
- 有没有类似项目可以参考？

**产出**: 一份需求要点列表。

### 步骤 2：初始化 CLAUDE.md

头脑风暴结束后，立即让 Claude 创建项目的 `CLAUDE.md`：

```
根据刚才的头脑风暴结果，帮我在项目根目录创建 CLAUDE.md，
包含：项目简介、功能范围、模块拆分初稿、进度跟踪表
```

> **为什么这一步不能跳过？**
> `CLAUDE.md` 是 Claude Code 的"长期记忆"。每次新会话自动加载。
> 没有它，下次开会话你得从头解释一遍背景。

### 步骤 3：技术调研（可选）

如果技术选型不确定，可以利用工具辅助决策：

- **Context7 (MCP)**: 查阅框架最新文档，对比方案
- **Crawl4AI / Agent Browser**: 抓取竞品或参考项目的实现
- **Audit Website**: 如果是改造已有站点，先做全面体检

```
用 Context7 查一下 Next.js 15 和 Nuxt 4 在 SSR 性能上的差异
```

---

## 4. Phase 1：架构设计

**目标**: 确定技术方案、模块边界、数据模型。

### 路径选择

| 项目规模 | 推荐方式 | 说明 |
|:---|:---|:---|
| 小型 (3-5 个文件) | `/plan "项目描述"` | 轻量，直接输出步骤 |
| 中大型 (5+ 个文件) | `/feature-dev "项目描述"` | 重量级，7 阶段自动流程 |

### 使用 `/feature-dev` 做架构

```
/feature-dev "实现一个 SaaS 订阅管理平台，支持 Stripe 支付、多租户、RBAC 权限"
```

**你需要介入的节点**：
- Phase 1 (Discovery): AI 追问时如实回答需求细节
- Phase 3 (Clarifying Questions): 确认关键歧义
- Phase 4 (Architecture): **在 2-3 种方案中选择一种**

**关键动作**：方案确认后，让 Claude 把架构决策写回 `CLAUDE.md`：

```
把刚才确认的架构方案更新到 CLAUDE.md 中，包含：
- 技术选型及理由
- 模块拆分与依赖关系
- 数据库 Schema 概要
- API 路由规划
```

### 生成架构图（推荐）

```
用 mermaid-diagrams 画出系统架构图和模块依赖关系图
```

将生成的 Mermaid 代码保存在项目中（如 `docs/architecture.md`），方便后续查阅。

### Phase 1 结束检查清单

- [ ] `CLAUDE.md` 已包含完整的架构信息
- [ ] 模块拆分明确，每个模块有清晰的职责边界
- [ ] 技术选型已确定并记录理由
- [ ] 数据模型已设计（至少是草案）
- [ ] `/commit` 提交当前状态

---

## 5. Phase 2：模块开发（核心循环）

**目标**: 按模块逐个实现，每个模块走完整的开发-测试-审查流程。

### 5.1 核心原则

1. **每次只做一个功能** — 不要试图在一次会话中完成所有模块。一次做太多会导致上下文耗尽，留下半成品（Anthropic 官方称此为 "one-shotting" 失败模式）。
2. **先基础后业务**: 数据库 → 认证 → 核心业务 → 辅助功能
3. **先后端后前端**: API → 页面 → 交互优化
4. **先主路径后边界**: Happy path → 错误处理 → 边界场景

### 5.2 单模块开发流程

每个模块按以下顺序执行：

```
┌─────────────────────────────────────────────────┐
│  Plan 模式 + /plan "模块描述" ← 规划（不动代码）  │
│       ↓                                         │
│  /tdd "功能描述"           ← 先写测试再实现        │
│       ↓                                         │
│  验证功能正确               ← 运行、测试、确认     │
│       ↓                                         │
│  /code-review              ← 质量检查            │
│       ↓                                         │
│  /commit                   ← 提交                │
│       ↓                                         │
│  更新 CLAUDE.md 进度        ← 持久化状态          │
└─────────────────────────────────────────────────┘
```

#### 第一步：规划模块实施

建议先切到 Plan 模式再调用 `/plan`（参见第 2 节）：

```
Shift+Tab → 进入 Plan 模式
/plan "实现订单模块的 CRUD API，包括创建订单、查询列表（分页）、查看详情、取消订单"
```

在 Plan 模式下讨论、确认步骤。满意后 `Shift+Tab` 切到 Normal 或 Auto-accept 模式开始编码。

#### 第二步：TDD 开发

```
/tdd "订单创建 API：接收商品ID和数量，校验库存，创建订单记录，返回订单号"
```

TDD 导师会引导你走 红 → 绿 → 重构 流程：
1. 先写失败的测试（红）
2. 写最少的代码让测试通过（绿）
3. 优化代码结构（重构）

> **一个模块可能需要多轮 `/tdd`**。
> 例如订单模块可能拆成：创建订单、查询列表、查看详情、取消订单，每个走一轮 TDD。

#### 第三步：验证

> *"给 Claude 一种验证自己工作的方式，质量会提升 2-3 倍。"* — Boris Cherny

**每个功能都应验证，不要等到最后。** 验证方式取决于项目类型：

- **API 项目**: 运行测试套件，用 curl 或 Postman 手动测一遍
- **Web 项目**: 启动 dev server，用 Agent Browser 或手动浏览器验证 UI
- **CLI 工具**: 运行实际命令，检查输出

```
运行 dev server 并验证刚才实现的订单创建功能是否正常工作
```

#### 第四步：代码审查

```
/code-review
```

修复审查发现的问题后继续。

#### 第五步：提交并更新进度

```
/commit
```

然后更新 `CLAUDE.md`：

```
帮我更新 CLAUDE.md 的进度，标记订单模块的 CRUD API 已完成
```

### 5.3 模块间的衔接

当一个模块完成、开始下一个模块时：

```
我已完成订单模块，现在开始开发支付模块。
请先阅读 CLAUDE.md 了解整体架构，然后 /plan "实现支付模块"
```

### 5.4 复杂模块的处理

如果单个模块本身很复杂（如支付集成），可以对该模块使用 `/feature-dev` 而不是 `/plan`：

```
/feature-dev "实现 Stripe 支付集成，支持一次性支付和订阅，包含 Webhook 处理"
```

---

## 6. Phase 3：集成与收尾

**目标**: 所有模块完成后的全局验证、优化和上线准备。

### 6.1 端到端测试

```
/e2e
```

覆盖关键用户流程：注册 → 登录 → 核心操作 → 支付 → 退出。

### 6.2 深度 PR 审查

```
/review-pr
```

这比 `/code-review` 更重，6 个维度的专家审查，适合合并到主分支前。

### 6.3 安全审查

Security Reviewer 会在涉及认证、用户输入时自动触发。
但在上线前建议手动做一次全面检查：

```
对整个项目做一次安全审查，重点检查认证流程、API 权限、输入校验
```

### 6.4 性能与审计（针对 Web 项目）

```
用 audit-website 对站点做全面体检
```

### 6.5 提交并创建 PR

```
/commit-push-pr
```

---

## 7. 会话管理：开始与结束仪式

Claude Code 的每次会话是独立的。通过固定的"仪式"保证跨会话的连续性。

### 恢复已有会话

在开新会话之前，先考虑是否可以恢复之前的会话：

```bash
claude -c                    # 继续最近一次会话（保留完整上下文）
claude --resume              # 弹出选择器，列出最近的会话供你选择
claude --resume abc123       # 恢复指定 ID 的会话
```

恢复的会话保留之前的全部对话上下文，不需要重新解释背景。

### 会话开始仪式（新会话）

如果是全新会话：

```
请阅读 CLAUDE.md，告诉我当前项目进度和下一步应该做什么
```

Claude 会自动加载 `CLAUDE.md`，但显式要求它总结一遍可以确保理解一致。

### 会话结束仪式

每次关闭会话前执行：

```
必做: /commit                        ← 确保代码已提交
必做: 更新 CLAUDE.md 的进度和下次入口   ← 为下次会话留交接信息
可选: /update-docs                   ← 有较多文件变更时更新代码地图
可选: /learn                         ← 踩到坑或发现重要经验时提取教训
```

更新 CLAUDE.md 的示例：

```
帮我更新 CLAUDE.md：
- 标记模块 B 已完成
- 在"下次继续的入口"写上：从模块 C（支付集成）开始，先设计 Webhook 处理流程
- 记录本次发现的注意事项（如果有）
```

### 会话仪式速查卡

```
┌──────────────────────────────────────────────────┐
│             恢复会话（优先）                       │
│  claude -c  或  claude --resume                   │
├──────────────────────────────────────────────────┤
│             新会话开始                            │
│  "请阅读 CLAUDE.md，总结进度和下一步"              │
├──────────────────────────────────────────────────┤
│             正常开发                              │
│  Plan模式 → /plan → /tdd → 验证 → /code-review   │
│  → /commit                                       │
├──────────────────────────────────────────────────┤
│             会话结束                              │
│  /commit → 更新CLAUDE.md → (可选)/update-docs/learn│
└──────────────────────────────────────────────────┘
```

---

## 8. 跨会话持续性策略

### 8.1 持久化层级

项目的"记忆"分三层，从自动到手动：

| 层级 | 载体 | 加载方式 | 内容 |
|:---|:---|:---|:---|
| **L1 自动** | `CLAUDE.md` | 每次会话自动加载 | 项目概况、架构、进度、下次入口 |
| **L2 半自动** | `/learn` 产出 | 持久化到 `~/.claude/` | 经验教训、踩坑记录 |
| **L3 手动** | `docs/` 目录下的文档 | 需要时手动让 Claude 读取 | 架构图、API 文档、设计决策记录 |

### 8.2 CLAUDE.md 的维护原则

1. **保持精简**: 控制在 200 行以内，过长会稀释关键信息
2. **结构稳定**: 使用固定的 section 结构，每次只更新变化的部分
3. **指令明确**: "下次继续的入口"要写得像交接文档——下一个人（或下一次的你）能直接上手
4. **定期清理**: 已完成的模块细节可以精简为一行记录，不需要保留完整的步骤

### 8.3 大型项目的分级策略

当项目超过 5 个模块时，考虑分级管理：

```
项目根目录/
├── CLAUDE.md              ← 全局：架构、模块清单、总进度
├── src/
│   ├── auth/
│   │   └── CLAUDE.md      ← 模块级：认证模块的细节上下文
│   ├── orders/
│   │   └── CLAUDE.md      ← 模块级：订单模块的细节上下文
│   └── payments/
│       └── CLAUDE.md      ← 模块级：支付模块的细节上下文
└── docs/
    └── architecture.md    ← 架构图（Mermaid）
```

根目录的 `CLAUDE.md` 保持全局视角，模块级的 `CLAUDE.md` 放该模块的详细上下文。

开发某个模块时：

```
请阅读根目录 CLAUDE.md 了解全局，然后阅读 src/payments/CLAUDE.md 了解支付模块详情
```

---

## 9. 质量关卡速查

在不同阶段应触发的质量检查：

| 时机 | 触发动作 | 说明 |
|:---|:---|:---|
| 写完一段代码 | `/code-review` | 日常轻量检查 |
| 构建失败 | `/fix` | 自动诊断修复 |
| 模块完成 | `/tdd` 确认覆盖率 80%+ | 测试覆盖率关卡 |
| 涉及数据库改动 | Database Reviewer 自动触发 | Schema、索引、RLS 检查 |
| 涉及认证/用户输入 | Security Reviewer 自动触发 | OWASP Top 10 检查 |
| 合并到主分支前 | `/review-pr` | 6 维度深度审查 |
| 上线前 | `/e2e` + `audit-website` | 端到端测试 + 全面审计 |

---

## 10. 故障排除与常见陷阱

### 构建失败

```
/fix
```

如果 `/fix` 无法解决，尝试更具针对性的命令：
- TypeScript 错误: `/build-fix`
- Go 编译错误: `/go-build`

### 测试失败

```
/tdd
```

原则：**修实现，不改测试**（除非测试本身有误）。

### 方向跑偏：Re-plan

> *"Plan Mode discipline: when something goes sideways, re-plan. Don't keep pushing."* — Boris Cherny

当发现实现偏离预期、越改越乱时，**停下来重新规划**，不要硬推：

```
Shift+Tab → 切回 Plan 模式
当前实现遇到了 XXX 问题，让我们重新规划一下方案
```

这比反复用 `/fix` 修补更有效。

### 会话上下文丢失

如果感觉 Claude 偏离了之前的约定：

```
请重新阅读 CLAUDE.md，严格按照其中的架构决策和技术选型继续开发
```

### 代码质量下降

```
/refactor-clean
```

分析死代码、冗余代码并安全清除。

### 常见陷阱（来自 Anthropic 官方总结）

| 陷阱 | 症状 | 对策 |
|:---|:---|:---|
| **One-shotting** | 试图一次做完所有模块，上下文耗尽，留下半成品 | 每次只做一个功能，做完提交再做下一个 |
| **Premature Completion** | Claude 看到已有部分功能就宣布完成，实际还有很多没做 | 在 CLAUDE.md 中维护明确的功能清单和状态标记 |
| **Context Exhaustion** | 项目后期 Claude 要读太多文件，上下文不够用 | 保持 CLAUDE.md 精简；用模块级 CLAUDE.md 分散上下文 |
| **MCP 上下文挤占** | 启用过多 MCP 后，200k 上下文缩减到 70k | 在项目配置中用 `disabledMcpServers` 禁用不需要的 MCP |

---

## 11. 附录：CLAUDE.md 模板

新项目初始化时推荐的 `CLAUDE.md` 结构：

```markdown
# [项目名称]

## 项目简介
一句话描述项目目标。

## 功能范围
### 包含 (In Scope)
- 功能 A
- 功能 B

### 不包含 (Out of Scope)
- 功能 X（计划 v2）
- 功能 Y（不做）

## 技术选型
| 类别 | 选择 | 理由 |
|:---|:---|:---|
| 框架 | | |
| 数据库 | | |
| 认证 | | |
| 部署 | | |

## 架构概览
（简要描述，可引用 docs/architecture.md 中的 Mermaid 图）

## 模块拆分与进度
| 模块 | 状态 | 会话 | 备注 |
|:---|:---|:---|:---|
| 数据库 Schema | 已完成 | Session 1 | |
| 用户认证 | 已完成 | Session 2 | |
| 订单系统 | 进行中 | Session 3 | CRUD 已完成，缺分页 |
| 支付集成 | 未开始 | - | |
| 管理后台 | 未开始 | - | |

## 当前进度
### 已完成
- 数据库 Schema 设计与迁移
- 用户注册/登录 API

### 进行中
- 订单系统：CRUD API 已完成，正在实现分页查询

## 下次继续的入口
从订单模块的分页查询开始。参考 src/orders/CLAUDE.md 中的 API 契约。
注意：分页使用 cursor-based 而非 offset-based（见 ADR-3）。

## 架构决策记录 (ADR)
### ADR-1: 选择 Next.js 而非 Nuxt
原因：团队更熟悉 React 生态...

### ADR-2: 使用 Supabase 而非自建 PostgreSQL
原因：MVP 阶段优先开发速度...

### ADR-3: 分页使用 cursor-based
原因：数据量大时 offset 性能差...

## 注意事项
- Stripe Webhook 需要配置公网 URL（开发时用 ngrok）
- 环境变量清单见 .env.example
```
